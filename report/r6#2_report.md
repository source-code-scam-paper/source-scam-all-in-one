# Sourcify Bug Report
## Background
Hello `Sourcify` project side. As we all know, sourcify is the official source code validation system and a service that directly supports source code validation by `metadata`, and its novel design is fantastic.

We saw a lot of humanized design in your project, for example, you automatically replace `immutable var` and `libraryaddress`.

## Risk Description

But some of these user-friendly designs in code may lead to serious risks.

For example, the following code is used to replace `libraryAddress` to provide user convenience.

```javascript
export function addLibraryAddresses(
  template: string,
  real: string
): {
  replaced: string;
  libraryMap: StringMap;
} {
  const PLACEHOLDER_START = '__$';
  const PLACEHOLDER_LENGTH = 40;

  const libraryMap: StringMap = {};

  let index = template.indexOf(PLACEHOLDER_START);
  for (; index !== -1; index = template.indexOf(PLACEHOLDER_START)) {
    const placeholder = template.slice(index, index + PLACEHOLDER_LENGTH);
    const address = real.slice(index, index + PLACEHOLDER_LENGTH);
    libraryMap[placeholder] = address;
    const regexCompatiblePlaceholder = placeholder
      .replace('__$', '__\\$')
      .replace('$__', '\\$__');
    const regex = RegExp(regexCompatiblePlaceholder, 'g');
    template = template.replace(regex, address);
  }
  return {
    replaced: template,
    libraryMap,
  };
}
```

You get the library placeholder in the bytecode by identifying `__$`. And constructed regular matching expressions from the placeholderï¼ŒBut note that not all versions use `hash` as a placeholder.
For example, the `0.4` Solidity version uses `__{Path/FileName}__` as a `placeholder`
![](https://i.imgur.com/BTSFsmO.png)

This allows a malicious user to manipulate your regular expressions, which in turn allows other parts of the bytecode to be marked as a library Address.

## Exploit

### Replace bytecode
As with the risks mentioned above, we can achieve arbitrary regular expression tampering by changing the file name of the library contract.
An example is the following:
```solidity
pragma solidity ^0.4.0;
import "./$.{37}|2{40}|cantbematchedcharacters__";
contract A {
    address constant public a = address(0x2222222222222222222222222222222222222222);
    uint public b;
    function cc() public{
        b = L_.get4();
    }
}
```

In the above code, we write a regular expression in the filename and the expression appears in the generated bytecode and is adopted by the `addLibraryAddresses` function.
![](https://i.imgur.com/gpsm01V.png)
This regular expression will first replace itself, and then look for `22..2` to do the same. Here `2{40}` can also be modified to `5b.{...}` to perform arbitrary replacements of executable bytecode.

And we constructed a [real attack case(0x4AD29c9716569f3c466BB123Efdd0B9B43207dE1 in goerli)](https://repo.sourcify.dev/contracts/partial_match/5/0x4AD29c9716569f3c466BB123Efdd0B9B43207dE1/sources/).

![](https://i.imgur.com/vU5KhnD.png)
![](https://i.imgur.com/gwNwRLR.png)
We implement the tampering of constants in the above case
(of course executable bytecode tampering is also possible, simply by changing `2{40}` to `5b.{...}` , and writing `L_` address to the `bytecode` we want).

### DOS Attack

In addition to performing bytecode tampering, we can also perform a DOS attack on sourcify. Specifically, we can design a regular expression that will not have any matches in `bytecode`, resulting in `__$` not being replaced, which in turn makes `addLibraryAddresses` a dead loop.



## Recommendation
We recommend deleting the operation of `addLibraryAddresses` as well as `replaceImmutableReferences` in the source code validation.

Secondly globally check if the regular matching expressions in your code can be controlled by the outside world and the dead loop issue.

And also mark the incorrect source code in your ipfs library to alert users.
## Other
Thank you very much for your open source work, the exact match feature of your source code validation system ensures that only the deployer can validate the source code with an exact match without worrying about other malicious users inserting comments, modifying library content, etc. This provides a lot of security.

As well as please give an acknowledgement in the fix PR or even other channels, it helps a lot in our work on the paper, much appreciated!
## Credits
[Lucas(PX) Ma](https://twitter.com/MaLucasBC)
[Samczsun](https://twitter.com/samczsun)
